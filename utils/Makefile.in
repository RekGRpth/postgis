# **********************************************************************
# *
# * PostGIS - Spatial Types for PostgreSQL
# * http://postgis.net
# *
# * Copyright (C) 2012-2022 Sandro Santilli <strk@kbt.io>
# * Copyright (C) 2008 Mark Cave-Ayland
# *
# * This is free software; you can redistribute and/or modify it under
# * the terms of the GNU General Public Licence. See the COPYING file.
# *
# **********************************************************************

top_builddir = @top_builddir@
srcdir = @srcdir@
top_srcdir = @top_srcdir@
datadir = @datadir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
INSTALL=@INSTALL@
INSTALL_DATA=@INSTALL_DATA@
SRID_MAXIMUM = @SRID_MAX@
SRID_USER_MAXIMUM = @SRID_USR_MAX@

VPATH := @srcdir@

SHELL = @SHELL@
INSTALL = $(SHELL) @top_srcdir@/build-aux/install-sh

SCRIPTS_built = postgis_restore.pl

SCRIPTS = \
	create_undef.pl \
	repo_revision.pl \
	create_upgrade.pl \
	profile_intersects.pl \
	test_estimation.pl \
	test_joinestimation.pl

all: $(SCRIPTS_built)

DROP_FILES = \
  $(top_srcdir)/raster/rt_pg/rtpostgis_upgrade_cleanup.sql.in \
  $(top_srcdir)/raster/rt_pg/rtpostgis_drop.sql.in \
  $(top_srcdir)/postgis/postgis_after_upgrade.sql \
  $(top_srcdir)/postgis/postgis_before_upgrade.sql

postgis_restore_data.hardcoded: postgis_restore.pl.in
	tac $< \
		| sed '/^__END__/q' \
		| grep -v '^__END__' \
    > $@

postgis_restore_data.generated: $(DROP_FILES)
	grep '^DROP FUNCTION IF EXISTS' $(DROP_FILES) | \
    cut -d: -f2 | sed 's/^DROP FUNCTION IF EXISTS //' | \
    sed 's/ *, */,/g' | \
    sed 's/ *( */(/g' | \
    sed 's/ *) */)/g' | \
    tr '[A-Z]' '[a-z]' | \
    sed 's/varchar/character varying/g' | \
    sed 's/float8/double precision/g' | \
    sed 's/\<int\>/integer/g' | \
    sed 's/\<int4\>/integer/g' | \
    sed 's/\<int8\>/bigint/g' | \
    sed 's/\(.*\); *\(--.*\)\?/FUNCTION \1/' \
		> $@

postgis_restore.pl: postgis_restore.pl.in postgis_restore_data.hardcoded postgis_restore_data.generated Makefile
	cat $< \
		| sed '/^__END__/q' \
		| sed 's,@SRID_MAXIMUM@,$(SRID_MAXIMUM),g;s,@SRID_USER_MAXIMUM@,$(SRID_USER_MAXIMUM),' \
		> postgis_restore.pl
	cat postgis_restore_data.hardcoded postgis_restore_data.generated \
		| sort -u >> postgis_restore.pl
	chmod +x $@

clean:
	rm -f $(SCRIPTS_built) postgis_restore_data.generated postgis_restore_data.hardcoded

distclean: clean
	rm -f Makefile

# And there's nothing to check
check check-unit check-regress:

installdir:
	@mkdir -p $(DESTDIR)$(bindir)

uninstall:
	rm -f $(addprefix '$(DESTDIR)$(bindir)'/, $(SCRIPTS_built))

install: installdir $(SCRIPTS_built)
	$(INSTALL) $(SCRIPTS_built) '$(DESTDIR)$(bindir)/'
